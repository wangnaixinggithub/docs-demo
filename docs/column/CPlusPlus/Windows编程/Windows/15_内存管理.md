# 内存管理



计算机的技术发展过程经历了以下阶段︰流水线、超标量、超线程、多核心、超频，计算机性能可谓飞速提高。CPU的发展历史可以大体归结为以下几个阶段(以Intel为例)∶

- lntel 4004 (1971—1973年，4位和8位CPU) ,
- lntel 8080 (1974—1977年，8位CPU) , lntel 8086(1978—1984年，16位CPU) 
- lntel 80386 (1985—1992年，32位CPU)，奔腾系列(1993—2005年，32/64位CPU)，酷睿系列(2005年至今，32/64位CPU) 。时至今日，Wlntel (Windows-Intel)联盟依然占据着绝大多数的桌面计算机市场。从16位处理器和DOS单任务操作系统，到32/64位多任务图形界面操作系统，无论多先进的硬件都有相应的操作系统支持。







> CPU有3种工作模式∶实模式、保护模式和虚拟8086模式。





学习过8086汇编语言的读者都知道，8086 CPU有20根地址总线，可以传送20位地址，具有1MB的寻址能力，但是8086 CPU是16位体系架构，通用寄存器、段寄存器、指合指针寄存器等都是16位,只有64KB的寻址能力。



为了寻址1MB，采用了`"段地址X 0x10＋偏移地址"`的方式来合成真实的物理内存地址。



**实模式**体现在程序中用到的地址都是真实的物理内存地址，`"段地址X 0x10＋偏移地址"`产生的逻辑地址就是物理内存地址。实模式下没有特权级的概念，或者说用户程序和操作系统拥有同样的特权级，程序可以随意修改任意物理内存地址处的内容，包括操作系统所在的内存，这给操作系统带来了极大的安全问题。



从80386开始，CPU的地址总线和寄存器都是32位，寻址范围为`0x00000000～OxFFFFFFFF`，即4GB大小，出现了**保护模式**的概念、内存分段管理机制和内存分页管理机制，为实现虚拟内存提供了硬件支持，支持多任务，能够快速地进行任务切换和保护任务环境，4个特权级和完善的特权检查机制，既能实现资源共享又能保证代码和数据的安全及任务的隔离。





以前，计算机可能没有如此大的物理内存(4GB)，为了运行大型程序和实现多任务，Windows采用了**虚拟内存技术**，即拿出一部分磁盘空间来充当内存空间，这部分空间称为虚拟内存。虚拟内存在磁盘上的存在形式是`PageFile.sys`页面文件(页面交换文件)，如果一个进程试图使用比当前可用物理内存更多的内存，系统会将一些物理内存内容分页到磁盘页面交换文件。



8GB-16GB内存的计算机已经普遍存在，在日常使用过程中16GB内存足够支撑我们完成绝大多数工作，但是虚拟内存的存在有时候和物理内存的大小无关，例如深度学习、科学实验计算等应用程序会自动将大量数据存放至虚拟内存中。细心且使用过这类软件的用户应该会发现，不论内存有多大，在虚拟内存中总会有几GB的数据。







保护模式下,每个进程使用的内存地址称为虚拟地址。每个进程都有自己的虚拟地址空间，对32位进程来说，可以使用的虚拟地址空间范围为`0x00000000～OxFFFFFFFF`，即4GB大小。虚拟地址空间使应用程序认为它拥有"连续可用的内存”，而实际上这些"连续可用的内存"通常由多个物理内存碎片组成,还有部分暂时存储在磁盘上，在需要的时候进行数据交换。



例如，进程A在0x12345678地址处存储了一个数据结构，而进程B也可以在0x12345678地址处存储一个完全不同的数据结构。

