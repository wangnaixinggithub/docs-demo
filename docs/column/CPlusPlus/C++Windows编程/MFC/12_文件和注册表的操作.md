# 文件和注册表的操作

## C语言对文件操作的支持

打开文件的方式：

![](https://blogwnx-bucket.oss-cn-beijing.aliyuncs.com/img/image-20240420200506044.png)



三步走实现文件写入。

```c
void CFileView::OnFileWrite()
{
	FILE *pFile;
	fopen_s(&pFile, "1.txt", "w");
	fwrite("http://www.phei.com.cn/", 1, strlen("http://www.phei.com.cn/"), pFile);
	fclose(pFile);
    //fflush() 在不关闭已经打开的文件的基础上，直接把缓冲系统的数据写入到磁盘文件
}
```

文件指针移动位置，通过影响写入的位置，进而影响写入结果。

![](https://blogwnx-bucket.oss-cn-beijing.aliyuncs.com/img/image-20240420190029268.png)

```c
void CFileView::OnFileWrite()
{
FILE *pFile;
fopen_s(&pFile, "1.txt", "w");
fwrite("http://wangnaixing.top", 1, strlen("http://wangnaixing.top"), pFile);
fseek(pFile, 0, SEEK_SET);
fwrite(" ftp:", 1, strlen(" ftp:"), pFile);
fclose(pFile);

//http://wangnaixing.top
				//		||
				//      文件指针

//fseek(pFile, 0, SEEK_SET);

// http://wangnaixing.top
// ||
// 文件指针
// ftp://wangnaixing.top
}
```

先查文件大小，动态创建内存，将内容写入，并补全字符串终止符。

```c
void CFileView::OnFileRead()
{

FILE* pFile;
fopen_s(&pFile,"1.txt", "r");
char* pBuf = NULL;

//求文件大小
fseek(pFile, 0, SEEK_END);
int len = ftell(pFile);


pBuf = new char[len + 1];
if(!pBuf)
{	
	return;
}	
rewind(pFile); //让文件指针指向文件开始处
fread(pBuf, 1, len, pFile);
pBuf[len] = 0;
fclose(pFile);
::MessageBoxA(NULL, pBuf, "文件", 0);
delete pBuf;
}
```

二进制文件和文本文件的区别



如果是文本文件方式写入，`fopen()` 默认就是文本文件方式写入的。那读取的时候，就也按照文本文件方式去读取。



因为Windows系统，会解析到有`ASCII码=10`的换行控制符，在写入的时候，不会直接写入10，而是写入1013（换行回车符）



而以文本文件方式读的时候，在解析到1013(换行回车符)的时候，不会将1013直接读入，而是读入10（换行符）



如果是二进制方式写入，文件不存在这一层转换，写入是多少字节，这个文件就是多少字节。

```c
void CFileView::OnFileWrite()
{

	FILE* pFile;
	fopen_s(&pFile,"2.txt", "w");
	char ch[3];
	ch[0] = 'a'; //用97这个数字表示了'a'
	ch[1] = 10;  //用10这个数字表示控制类型字符换行
	ch[2] = 'b';//用98这个数字表示了'b'
	fwrite(ch, 1, 3, pFile);
	fclose(pFile);
}
```

 

## C++对文件操作的支持

指定文件打开的模式:

![](https://blogwnx-bucket.oss-cn-beijing.aliyuncs.com/img/image-20240420202701344.png)



指定文件保护规格说明:

![](https://blogwnx-bucket.oss-cn-beijing.aliyuncs.com/img/image-20240420202748739.png)

```c
void CFileView::OnFileWrite()
{
	ofstream ofs("4.txt");
	ofs.write("http://www.phei.com.cn/", strlen("http://www.phei.com.cn/"));
	ofs.close();
}
```

```c
void CFileView::OnFileRead()
{
	ifstream ifs("4.txt");
	char ch[100];
	memset(ch, 0, 100);
	ifs.read(ch, 100);
	ifs.close();
	::MessageBoxA(NULL, ch, "文件", 0);
}
```

## Win32 API对文件操作的支持

```c
void CFileView::OnFileRead()
{
	HANDLE hFile;
	char ch[100];
	DWORD dwReads;

	//打开文件
	hFile = CreateFile(L"5.txt", GENERIC_READ, 0, NULL, OPEN_EXISTING,
		FILE_ATTRIBUTE_NORMAL, NULL);


	//读取数据
	ReadFile(hFile, ch, 100, &dwReads, NULL);
	ch[dwReads] = 0;
	CloseHandle(hFile);
	MessageBoxA(NULL, ch, "文件", 0); 
}
```



```c
void CFileView::OnFileWrite()
{
	HANDLE hFile;
	//创建文件
	hFile = CreateFile(L"5.txt", GENERIC_WRITE, 0, NULL, CREATE_NEW,
		FILE_ATTRIBUTE_NORMAL, NULL);
	
	DWORD dwWrites;
	//写入数据
	WriteFile(hFile, "http://www.phei.com.cn/", strlen("http://www.phei.com.cn/"),
		&dwWrites, NULL);

	CloseHandle(hFile);	
}
```

## MFC对文件操作的支持

```c
void CFileView::OnFileWrite()
{
	CFile file(L"6.txt", CFile::modeCreate | CFile::modeWrite);
	file.Write("http://www.phei.com.cn/", strlen("http://www.phei.com.cn/"));
	file.Close();
}
```



```c
void CFileView::OnFileRead()
{
    CFile file(L"6.txt", CFile::modeRead);
    char *pBuf;
    UINT dwFileLen;
    dwFileLen = (UINT)file.GetLength();
    pBuf = new char[dwFileLen + 1];
    pBuf[dwFileLen] = 0;
    file.Read(pBuf, dwFileLen);
    file.Close();
    MessageBoxA(NULL, pBuf, "文件", 0);
}
```

## Win.ini文件的访问

Win.ini文件的写入

```c
BOOL CFileApp::InitInstance()
{
    ....
     //当MFC应用启动初始化的时候，写入一行section指定的key=value,到file.ini配置文件中
	::WritePrivateProfileString(L"http://www.phei.com.cn/", L"admin",
		L"zhangsan", L".\\file.ini");
    
    ...
}
```

Win.ini文件的读取

```c

BOOL CFileApp::InitInstance()
{	
    //读这个节 http://www.phei.com.cn/中key=admin的键值对的值，如果不存在这个key，则将默认值lisi注入到str中，反之则将value值注入到strz中 
    CString str;
    ::GetPrivateProfileString(L"http://www.phei.com.cn/", 
        L"admin", L"lisi", str.GetBuffer(100), 100, L".\\file.ini");
    AfxMessageBox(str);
}c
```

调用CWinApp类的WriteProfileString函数之后，将把信息写入到注册表中。

```c
BOOL CFileApp::InitInstance()
{
	// 如果一个运行在 Windows XP 上的应用程序清单指定要
	// 使用 ComCtl32.dll 版本 6 或更高版本来启用可视化方式，
	//则需要 InitCommonControlsEx()。  否则，将无法创建窗口。
	INITCOMMONCONTROLSEX InitCtrls;
	InitCtrls.dwSize = sizeof(InitCtrls);
	// 将它设置为包括所有要在应用程序中使用的
	// 公共控件类。
	InitCtrls.dwICC = ICC_WIN95_CLASSES;
	InitCommonControlsEx(&InitCtrls);

	CWinApp::InitInstance();


	// 初始化 OLE 库
	if (!AfxOleInit())
	{
		AfxMessageBox(IDP_OLE_INIT_FAILED);
		return FALSE;
	}

	AfxEnableControlContainer();

	EnableTaskbarInteraction(FALSE);


	//会生成注册表路径
	//计算机\HKEY_CURRENT_USER\Software\www.phei.com.cn
	SetRegistryKey(_T("www.phei.com.cn")); 

	LoadStdProfileSettings(4);  // 加载标准 INI 文件选项(包括 MRU)
	

	// 注册应用程序的文档模板。  文档模板
	// 将用作文档、框架窗口和视图之间的连接
	CSingleDocTemplate* pDocTemplate;
	pDocTemplate = new CSingleDocTemplate(
		IDR_MAINFRAME,
		RUNTIME_CLASS(CFileDoc),
		RUNTIME_CLASS(CMainFrame),       // 主 SDI 框架窗口
		RUNTIME_CLASS(CFileView));
	if (!pDocTemplate)
		return FALSE;
	AddDocTemplate(pDocTemplate);


	// 分析标准 shell 命令、DDE、打开文件操作的命令行
	CCommandLineInfo cmdInfo;
	ParseCommandLine(cmdInfo);



	// 调度在命令行中指定的命令。  如果
	// 用 /RegServer、/Register、/Unregserver 或 /Unregister 启动应用程序，则返回 FALSE。
	if (!ProcessShellCommand(cmdInfo))
		return FALSE;

	// 唯一的一个窗口已初始化，因此显示它并对其进行更新
	m_pMainWnd->ShowWindow(SW_SHOW);
	m_pMainWnd->UpdateWindow();



	//注册表路径：计算机\HKEY_CURRENT_USER\Software\www.phei.com.cn\File\http://www.phei.com.cn/
	//key=admin value =zhangsan
	this->WriteProfileString(L"http://www.phei.com.cn/", L"admin", L"zhangsan");
	

	//读取
	CString str;
	str = this->GetProfileString(L"http://www.phei.com.cn/", L"admin");
	AfxMessageBox(str);

	return TRUE;
}

```

![](https://blogwnx-bucket.oss-cn-beijing.aliyuncs.com/img/image-20240420205553951.png)

## 注册表的编程

```c
void CFileView::OnRegWrite()
{	
	HKEY hKey;
	LONG lResult;  
	lResult = RegCreateKeyEx(HKEY_LOCAL_MACHINE, 
		L"Software\\www.phei.com.cn\\admin",
		0, NULL, REG_OPTION_NON_VOLATILE, 
		KEY_WRITE | KEY_WOW64_64KEY, NULL, &hKey, NULL);

	if (lResult == ERROR_SUCCESS)
	{
		MessageBox(L"创建注册表项成功");
	}
	else
	{
		MessageBox(L"创建注册表项失败");
		return;
	}
	//默认key 写入值
	RegSetValue(hKey, NULL, REG_SZ, L"zhangsan", _tcslen(L"zhangsan"));
	DWORD dwAge = 30;
	//agekey 写入值
	RegSetValueEx(hKey, L"age", 0, REG_DWORD, (CONST BYTE*)&dwAge, 4);

	RegCloseKey(hKey);
	
}
```

![](https://blogwnx-bucket.oss-cn-beijing.aliyuncs.com/img/image-20240420211139642.png)



```c
void CFileView::OnRegRead()
{
	{ 
		HKEY hKey;
		LONG lValue;
		RegOpenKeyEx(HKEY_LOCAL_MACHINE, L"Software", 0,
			KEY_READ | KEY_WOW64_64KEY, &hKey);
		LONG lResult;
		lResult = RegQueryValue(hKey,
			L"www.phei.com.cn\\admin", NULL, &lValue);
		if (lResult == ERROR_SUCCESS)
		{
			TCHAR* pBuf = new TCHAR[lValue];
			RegQueryValue(hKey, L"www.phei.com.cn\\admin", pBuf, &lValue);
			MessageBox(pBuf);
		}
	}

	{
		HKEY hKey;
		RegOpenKeyEx(HKEY_LOCAL_MACHINE,
			L"Software\\www.phei.com.cn\\admin",
			0, KEY_READ | KEY_WOW64_64KEY, &hKey);
		DWORD dwType;
		DWORD dwValue;
		DWORD dwAge;
		RegQueryValueEx(hKey, L"age", 0, &dwType, (LPBYTE)&dwAge, &dwValue);
		CString str;
		str.Format(L"age=%d", dwAge);
		MessageBox(str);
	}

}
```

